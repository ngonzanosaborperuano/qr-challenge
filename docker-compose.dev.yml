services:
  # API Node.js - Modo Desarrollo
  node-api:
    build:
      context: ./node-api
      dockerfile: Dockerfile.dev
    container_name: qr-challenge-node-api-dev
    ports:
      - "${NODE_API_PORT:-3001}:3001"
    environment:
      - PORT=${NODE_API_PORT:-3001}
      - NODE_ENV=${NODE_ENV:-development}
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in}
    volumes:
      # Montar código fuente para hot-reload
      - ./node-api/src:/app/src
      - ./node-api/package.json:/app/package.json
      - ./node-api/package-lock.json:/app/package-lock.json
      # Excluir node_modules del volumen (usar los del contenedor)
      - /app/node_modules
    command: npm run dev
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - qr-network

  # API Go - Modo Desarrollo
  go-api:
    build:
      context: ./go-api
      dockerfile: Dockerfile.dev
    container_name: qr-challenge-go-api-dev
    ports:
      - "${GO_API_PORT:-3000}:3000"
    environment:
      - PORT=${GO_API_PORT:-3000}
      - NODE_API_URL=${NODE_API_URL:-http://node-api:3001}
      - CGO_ENABLED=${CGO_ENABLED:-0}
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in}
    volumes:
      # Montar código fuente para hot-reload
      - ./go-api:/app
    command: go run cmd/server/main.go
    depends_on:
      node-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - qr-network

  # Frontend Angular - Modo Desarrollo
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: qr-challenge-frontend-dev
    ports:
      - "${FRONTEND_PORT:-4200}:4200"
    volumes:
      # Montar código fuente para hot-reload
      - ./frontend/src:/app/src
      - ./frontend/angular.json:/app/angular.json
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/package.json:/app/package.json
      # Excluir node_modules del volumen
      - /app/node_modules
    command: npm start -- --host 0.0.0.0 --port 4200
    depends_on:
      - go-api
      - node-api
    networks:
      - qr-network

networks:
  qr-network:
    driver: bridge

